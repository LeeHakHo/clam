#!/bin/bash
#SBATCH --account=biyik_1165
#SBATCH --partition=gpu
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=32
#SBATCH --gpus-per-task=v100:1
#SBATCH --mem=184G
#SBATCH --time=10:00:00
#!/bin/bash 

#conda create -n clam python=3.11

source ~/miniconda3/etc/profile.d/conda.sh
conda activate clam
cd clam
export WANDB_API_KEY="61a1a21df93bbb2da31d41abc3400294b59ba6eb"

echo "dreamer_rollout/ vq x / context_len 32"
export PYTHONPATH=$PWD:$PYTHONPATH


nvidia-smi 


# #Train TSSM --------------
# python3 main.py --config-name=train_tssm_clam \
#     env=metaworld \
#     env.dataset_name=oxe/oxe_train_0.1_128\
#     env.datasets='[jesbu1_oxe_rfm_oxe_aloha_mobile, jesbu1_oxe_rfm_oxe_austin_buds_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_bc_z, jesbu1_oxe_rfm_oxe_berkeley_cable_routing, jesbu1_oxe_rfm_oxe_berkeley_fanuc_manipulation, jesbu1_oxe_rfm_oxe_berkeley_mvp_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_berkeley_rpt_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_bridge_v2, jesbu1_oxe_rfm_oxe_dlr_edan_shared_control_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_droid, jesbu1_oxe_rfm_oxe_fractal20220817_data, jesbu1_oxe_rfm_oxe_furniture_bench_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_iamlab_cmu_pickup_insert_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_imperialcollege_sawyer_wrist_cam, jesbu1_oxe_rfm_oxe_jaco_play, jesbu1_oxe_rfm_oxe_language_table, jesbu1_oxe_rfm_oxe_nyu_rot_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_robo_set, jesbu1_oxe_rfm_oxe_stanford_hydra_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_tokyo_u_lsmo_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_toto, jesbu1_oxe_rfm_oxe_ucsd_kitchen_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_utaustin_mutex]'\
#     env.eval_dataset_name=oxe/oxe_eval_0.1_128\
#     env.eval_datasets='[jesbu1_oxe_rfm_eval_oxe_berkeley_cable_routing_eval, jesbu1_oxe_rfm_eval_oxe_bc_z_eval, jesbu1_oxe_rfm_eval_oxe_bridge_v2_eval, jesbu1_oxe_rfm_eval_oxe_jaco_play_eval, jesbu1_oxe_rfm_eval_oxe_toto_eval, jesbu1_oxe_rfm_eval_oxe_viola_eval]' \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     data.use_cache=True \
#     log_rollout_videos=False \
#     model.idm.quantize_la=True  \
#     model.idm.use_quantized_las=True 

#Train TSSM with metaworld
python3 main.py --config-name=train_tssm_clam  \
    env=metaworld \
    env.dataset_name=metaworld/metaworld_train\
    env.datasets='[metaworld_train]' \
    env.eval_dataset_name=metaworld/metaworld_eval\
    env.eval_datasets='[metaworld_eval]' \
    joint_action_decoder_training=False \
    use_wandb=True \
    env.image_obs=True \
    model.image_obs=True \
    data.image_obs=True   \
    data.use_cache=True \
    log_rollout_videos=False \
    model.idm.quantize_la=True  \
    model.idm.use_quantized_las=True 


#Train TSSM --------------
# python3 main.py --config-name=train_tssm_clam \
#     env=metaworld \
#     env.dataset_name=language_table_30/samples\
#     env.datasets='[chunk-005, chunk-006, chunk-007, chunk-008, chunk-009, chunk-010, chunk-011 , chunk-012, chunk-013, chunk-014, chunk-015, chunk-016, chunk-017, chunk-018, chunk-019, chunk-020,chunk-021 , chunk-022, chunk-023, chunk-024, chunk-025, chunk-026, chunk-027, chunk-028, chunk-029]' \
#     env.eval_dataset_name=language_table_30/samples\
#     env.eval_datasets='[chunk-000, chunk-001, chunk-002, chunk-003, chunk-004]' \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     data.use_cache=True \
#     log_rollout_videos=False \
#     model.idm.quantize_la=True  \
#     model.idm.use_quantized_las=True 



#Multi-GPU Train TSSM --------------
# accelerate launch --num_processes 2 \
#     --num_machines 1 \
#     --mixed_precision fp16 \
#     main.py --config-name=train_tssm_clam \
#     env=metaworld \
#     env.dataset_name=language_table_30/samples\
#     env.datasets='[chunk-005, chunk-006, chunk-007, chunk-008, chunk-009, chunk-010, chunk-011 , chunk-012, chunk-013, chunk-014, chunk-015, chunk-016, chunk-017, chunk-018, chunk-019, chunk-020,chunk-021 , chunk-022, chunk-023, chunk-024, chunk-025, chunk-026, chunk-027, chunk-028, chunk-029]' \
#     env.eval_dataset_name=language_table_30/samples\
#     env.eval_datasets='[chunk-000 , chunk-001, chunk-002, chunk-003, chunk-004]' \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     data.use_cache=True \
#     log_rollout_videos=False \
#     model.idm.quantize_la=False  \
#     model.idm.use_quantized_las=False 



#Train oxe_0.1 dataset with multi-GPU-----------

# accelerate launch --num_processes 2 \
#     --num_machines 1 \
#     --mixed_precision fp16 \
#     main.py --config-name=train_st_clam \
#     env=metaworld \
#     env.dataset_name=oxe/oxe_train_0.1_128\
#     env.datasets='[jesbu1_oxe_rfm_oxe_aloha_mobile, jesbu1_oxe_rfm_oxe_austin_buds_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_bc_z, jesbu1_oxe_rfm_oxe_berkeley_cable_routing, jesbu1_oxe_rfm_oxe_berkeley_fanuc_manipulation, jesbu1_oxe_rfm_oxe_berkeley_mvp_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_berkeley_rpt_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_bridge_v2, jesbu1_oxe_rfm_oxe_dlr_edan_shared_control_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_droid, jesbu1_oxe_rfm_oxe_fractal20220817_data, jesbu1_oxe_rfm_oxe_furniture_bench_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_iamlab_cmu_pickup_insert_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_imperialcollege_sawyer_wrist_cam, jesbu1_oxe_rfm_oxe_jaco_play, jesbu1_oxe_rfm_oxe_language_table, jesbu1_oxe_rfm_oxe_nyu_rot_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_robo_set, jesbu1_oxe_rfm_oxe_stanford_hydra_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_tokyo_u_lsmo_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_toto, jesbu1_oxe_rfm_oxe_ucsd_kitchen_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_utaustin_mutex]'\
#     env.eval_dataset_name=oxe/oxe_eval_0.1_128\
#     env.eval_datasets='[jesbu1_oxe_rfm_eval_oxe_bc_z_eval, jesbu1_oxe_rfm_eval_oxe_berkeley_cable_routing_eval, jesbu1_oxe_rfm_eval_oxe_bridge_v2_eval, jesbu1_oxe_rfm_eval_oxe_jaco_play_eval, jesbu1_oxe_rfm_eval_oxe_toto_eval, jesbu1_oxe_rfm_eval_oxe_viola_eval]' \
#     env.env_id=assembly-v2 \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     log_rollout_videos=False \
#     data.use_cache=True \
#     accelerate.use=True \
#     accelerate.use_fp16=True

#Train oxe_0.1 dataset-----------

# python3 main.py --config-name=train_st_clam \
#     env=metaworld \
#     env.dataset_name=oxe/oxe_train_0.1_128\
#     env.datasets='[jesbu1_oxe_rfm_oxe_aloha_mobile, jesbu1_oxe_rfm_oxe_austin_buds_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_bc_z, jesbu1_oxe_rfm_oxe_berkeley_cable_routing, jesbu1_oxe_rfm_oxe_berkeley_fanuc_manipulation, jesbu1_oxe_rfm_oxe_berkeley_mvp_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_berkeley_rpt_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_bridge_v2, jesbu1_oxe_rfm_oxe_dlr_edan_shared_control_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_droid, jesbu1_oxe_rfm_oxe_fractal20220817_data, jesbu1_oxe_rfm_oxe_furniture_bench_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_iamlab_cmu_pickup_insert_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_imperialcollege_sawyer_wrist_cam, jesbu1_oxe_rfm_oxe_jaco_play, jesbu1_oxe_rfm_oxe_language_table, jesbu1_oxe_rfm_oxe_nyu_rot_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_robo_set, jesbu1_oxe_rfm_oxe_stanford_hydra_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_tokyo_u_lsmo_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_toto, jesbu1_oxe_rfm_oxe_ucsd_kitchen_dataset_converted_externally_to_rlds, jesbu1_oxe_rfm_oxe_utaustin_mutex]'\
#     env.eval_dataset_name=oxe/oxe_eval_0.1_128\
#     env.eval_datasets='[jesbu1_oxe_rfm_eval_oxe_bc_z_eval, jesbu1_oxe_rfm_eval_oxe_berkeley_cable_routing_eval, jesbu1_oxe_rfm_eval_oxe_bridge_v2_eval, jesbu1_oxe_rfm_eval_oxe_jaco_play_eval, jesbu1_oxe_rfm_eval_oxe_toto_eval, jesbu1_oxe_rfm_eval_oxe_viola_eval]' \
#     env.env_id=assembly-v2 \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     log_rollout_videos=False \
#     run_eval_rollouts=False \
#     data.use_cache=True \
#     accelerate.use=False \
#     accelerate.use_fp16=False


#Train metaworld dataset------------

# python3 main.py --config-name=train_st_clam \
#     env=metaworld \
#     env.dataset_name=metaworld/metaworld_train\
#     env.datasets='[metaworld_train]' \
#     env.eval_dataset_name=metaworld/metaworld_eval\
#     env.eval_datasets='[metaworld_eval]' \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     data.use_cache=True \
#     log_rollout_videos=False \
#     model.idm.quantize_la=True

#Train Language table --------------
# python3 main.py --config-name=train_nsvq_clam \
#     env=metaworld \
#     env.dataset_name=language_table_30/samples\
#     env.datasets='[chunk-005, chunk-006, chunk-007, chunk-008, chunk-009, chunk-010, chunk-011 , chunk-012, chunk-013, chunk-014, chunk-015, chunk-016, chunk-017, chunk-018, chunk-019, chunk-020,chunk-021 , chunk-022, chunk-023, chunk-024, chunk-025, chunk-026, chunk-027, chunk-028, chunk-029]' \
#     env.eval_dataset_name=language_table_30/samples\
#     env.eval_datasets='[chunk-000 , chunk-001, chunk-002, chunk-003, chunk-004]' \
#     joint_action_decoder_training=False \
#     use_wandb=True \
#     env.image_obs=True \
#     model.image_obs=True \
#     data.image_obs=True   \
#     data.use_cache=True \
#     log_rollout_videos=False \
#     model.idm.quantize_la=True  \
#     model.idm.use_quantized_las=True 

    
